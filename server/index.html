<!DOCTYPE html>
<html><head>
  <title>Patchwork</title>
</head><body>

<div id='agents-container'>
</div>

<div id='action-template' class='action-container' style='display: none'>
  <button class='action-btn'></button>
  <span class='action-prog'></span>
</div>
<div id='slider-template' class='slider-container' style='display: none'>
  <input type='range' class='slider-input'></input>
  <div class='slider-text'>
    <span class='slider-name'></span> = <span class='slider-disp'></span>
    <span class='slider-prog'></span>
  </div>
</div>

<div id='agent-template' class='agent-container' style='display: none'>
  <div class='agent-aux-info'>
    <div class='agent-conn-at'></div>
  </div>
  <div class='agent-disp'></div>
</div>

<style>
#agents-container {
  min-height: 100%;
  margin: 0 auto;
  width: 100%;
  max-width: 80vh;
  position: relative;
}

.agent-container {
  width: 100%;
  border: 1px solid black;
  border-radius: 4px;
  padding: 12px 18px 3px 18px;
  margin: 18px 0;
}
.agent-disp {
  margin: 0 0 12px 0;
  font-size: 1.5em;
}
.agent-aux-info {
  margin: 0;
  display: inline-block;
  float: right;
  color: #aaa;
}
.agent-aux-info div {
  display: inline-block;
}

.action-container {
  margin: 0 0 9px 0;
}
.action-container button {
  border: 1px solid black;
  border-radius: 4px;
  background: #eee;
  padding: 6px 0;
  min-width: 50%;
  font-size: 1rem;
  transition: background 0.1s ease;
}
.action-container button:hover {
  background: #ddd;
}
.action-container button:focus {
  background: #ccc;
}

.slider-container {
  margin: 0 0 9px 0;
  width: 100%;
  display: flex;
}
.slider-input {
  margin: 0;
  width: 50%;
  height: 28px;
  flex: 1 1 50%;
}
.slider-text {
  display: inline-block;
  margin-left: 9px;
  height: 28px;
  flex: 1 1 50%;
}

.prog-pend:before {
  content: 'pend';
}
.prog-done:before {
  content: 'done';
}
</style>

<script>
(async () => {
const agentsContainer = document.getElementById('agents-container')
const templ = document.getElementById('agent-template')
const templAction = document.getElementById('action-template')
const templSlider = document.getElementById('slider-template')

const agents = {}
let socket

const send = (o) => socket.send(JSON.stringify(o))

const createAgent = ({ id, disp, elements }) => {
  const agentDiv = templ.cloneNode(true)
  agentDiv.id = 'agent-div-' + id
  agentDiv.style.removeProperty('display')
  agentsContainer.appendChild(agentDiv)
  agentDiv.querySelector('.agent-disp').innerText = disp
  agentDiv.querySelector('.agent-conn-at').innerText = (new Date()).toLocaleString()

  const actionBtn = {}
  const actionProg = {}
  const sliderInput = {}
  const sliderDisp = {}
  const sliderProg = {}

  const actionMaxTs = {}
  const sliderMaxTs = {}

  const sliderAdjustedVal = {}
  const sliderPointerHeld = {}
  const sliderDisableSend = {}

  for (const el of elements) {
    if (el.type === 'action') {
      const { name: action, disp } = el
      const actionDiv = templAction.cloneNode(true)
      actionDiv.style.removeProperty('display')
      agentDiv.appendChild(actionDiv)
      actionBtn[action] = actionDiv.querySelector('.action-btn')
      actionProg[action] = actionDiv.querySelector('.action-prog')
      actionBtn[action].innerText = disp
      actionBtn[action].addEventListener('click', (e) => {
        const ts = Date.now()
        send({ type: 'act', id, ts, action })
        actionMaxTs[action] = ts
        actionProg[action].classList.remove('prog-done')
        actionProg[action].classList.add('prog-pend')
      })
    } else if (el.type === 'slider') {
      const { name: key, disp, min, max, step, val } = el
      const sliderDiv = templSlider.cloneNode(true)
      sliderDiv.style.removeProperty('display')
      agentDiv.appendChild(sliderDiv)
      sliderInput[key] = sliderDiv.querySelector('.slider-input')
      sliderDisp[key] = sliderDiv.querySelector('.slider-disp')
      sliderProg[key] = sliderDiv.querySelector('.slider-prog')
      sliderInput[key].setAttribute('min', min)
      sliderInput[key].setAttribute('max', max)
      sliderInput[key].setAttribute('step', step)
      const sliderName = sliderDiv.querySelector('.slider-name')
      sliderName.innerText = disp
      sliderInput[key].value = val
      sliderDisp[key].innerText = val.toString()
      sliderAdjustedVal[key] = val
      let timer
      sliderPointerHeld[key] = false
      sliderDisableSend[key] = false
      sliderInput[key].addEventListener('input', () => {
        if (sliderDisableSend[key]) return
        const val = sliderInput[key].value
        sliderAdjustedVal[key] = val
        if (timer !== undefined) clearInterval(timer)
        timer = setTimeout(() => {
          timer = undefined
          const ts = Date.now()
          send({ type: 'set', id, ts, key, val })
          sliderMaxTs[key] = ts
          sliderProg[key].classList.remove('prog-done')
          sliderProg[key].classList.add('prog-pend')
        }, 200)
      })
      sliderInput[key].addEventListener('mousedown', () => {
        sliderPointerHeld[key] = true
      })
      sliderInput[key].addEventListener('mouseup', () => {
        sliderPointerHeld[key] = false
        setTimeout(() => {
          sliderDisableSend[key] = true
          sliderInput[key].value = sliderAdjustedVal[key]
          sliderDisableSend[key] = false
        }, 100)
      })
    }
  }

  let actionDoneTimer = {}
  const done = (ts, action) => {
    if (ts === actionMaxTs[action]) {
      actionProg[action].classList.remove('prog-pend')
      actionProg[action].classList.add('prog-done')
      if (actionDoneTimer[action] !== undefined)
        clearInterval(actionDoneTimer[action])
      actionDoneTimer[action] = setInterval(() => {
        actionDoneTimer[action] = undefined
        actionProg[action].classList.remove('prog-done')
      }, 3000)
    }
  }

  let sliderDoneTimer = {}
  const update = (ts, key, val) => {
    sliderDisp[key].innerText = val.toString()
    sliderAdjustedVal[key] = val
    if (!sliderPointerHeld[key]) {
      sliderDisableSend[key] = true
      sliderInput[key].value = sliderAdjustedVal[key]
      sliderDisableSend[key] = false
    }
    if (ts === sliderMaxTs[key]) {
      sliderProg[key].classList.remove('prog-pend')
      sliderProg[key].classList.add('prog-done')
      if (sliderDoneTimer[key] !== undefined)
        clearInterval(sliderDoneTimer[key])
      sliderDoneTimer[key] = setInterval(() => {
        sliderDoneTimer[key] = undefined
        sliderProg[key].classList.remove('prog-done')
      }, 3000)
    }
  }

  const destroy = () => agentDiv.remove()

  return {
    done,
    update,
    destroy,
  }
}

const reconnect = () => {
  socket = new WebSocket('ws://localhost:1026/admin')
  socket.onopen = () => {
  }
  socket.onclose = () => {
    for (const id in agents) {
      agents[id].destroy()
      delete agents[id]
    }
    setTimeout(() => reconnect(), 1000)
  }
  socket.onmessage = (e) => {
    const o = JSON.parse(e.data)
    console.log(o)
    if (o.type === 'agent-on') {
      agents[o.id] = createAgent(o)
    } else if (o.type === 'agent-off') {
      agents[o.id].destroy()
      delete agents[o.id]
    } else if (o.type === 'agent-done') {
      agents[o.id].done(o.ts, o.action)
    } else if (o.type === 'agent-upd') {
      agents[o.id].update(o.ts, o.key, o.val)
    }
  }
}
reconnect()
})()
</script>

</body></html>
